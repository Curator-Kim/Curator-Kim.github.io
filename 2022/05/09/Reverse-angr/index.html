<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Reverse angr - Curator-Kim的小站</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Curator-Kim的小站"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Curator-Kim的小站"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="[Toc]"><meta property="og:type" content="blog"><meta property="og:title" content="Curator-Kim"><meta property="og:url" content="https://curator-kim.github.io/"><meta property="og:site_name" content="Curator-Kim"><meta property="og:description" content="[Toc]"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://curator-kim.github.io/img/icon.jpg"><meta property="article:published_time" content="2022-05-09T08:14:14.000Z"><meta property="article:modified_time" content="2022-12-26T15:39:12.485Z"><meta property="article:author" content="Curator-Kim"><meta property="article:tag" content="CTF"><meta property="article:tag" content="Reverse"><meta property="article:tag" content="angr"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/icon.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://curator-kim.github.io/2022/05/09/Reverse-angr/"},"headline":"Curator-Kim的小站","image":["http://curator-kim.github.io/2022/05/09/Reverse-angr/image-20220505162352974.png","http://curator-kim.github.io/2022/05/09/Reverse-angr/image-20220506163556300.png","http://curator-kim.github.io/2022/05/09/Reverse-angr/image-20220509104313706-16520641942771.png"],"datePublished":"2022-05-09T08:14:14.000Z","dateModified":"2022-12-26T15:39:12.485Z","author":{"@type":"Person","name":"Curator-Kim"},"description":"[Toc]"}</script><link rel="canonical" href="http://curator-kim.github.io/2022/05/09/Reverse-angr/"><link rel="icon" href="https://cdn.jsdelivr.net/gh/removeif/removeif-demo@latest/img/favicon.png"><meta name="referrer" content="no-referrer-when-downgrade"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro|Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Microsoft YaHei:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&amp;amp;subset=latin,latin-ext|Inconsolata|Itim|Lobster.css"><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="/js/globalUtils.js"></script><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><link rel="stylesheet" href="/live2d/waifu.css"><script type="text/javascript" async src="/live2d/autoload.js"></script><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column has-navbar-fixed-top"><nav class="navbar navbar-main is-fixed-top"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://github.com/Curator-Kim/Curator-Kim.github.io/blob/master/img/logo.png?raw=true" alt="Curator-Kim的小站" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a><a class="navbar-item" href="/album">Album</a><a class="navbar-item" href="/friend">Friend</a><a class="navbar-item" href="/message">Message</a><a class="navbar-item" href="/self-talking">Self-talking</a><a class="navbar-item" href="/music">Music</a><a class="navbar-item" href="/media">Media</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Join Gitter" href="https://gitter.im/hexo-theme-amazing/community"><i class="fab fa-gitter"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a><a class="navbar-item" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a></div></div></div></nav><script type="text/javascript" src="/js/theme-setting.js"></script><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><!--!--><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><i class="far fa-calendar-plus"> </i>2022-05-09  <a class="commentCountImg" href="/2022/05/09/Reverse-angr/#comment-container"><span class="display-none-class">0b5995360e1c8fe119df90069aceab92</span><i class="far fa-comment-dots"></i> <span class="commentCount" id="0b5995360e1c8fe119df90069aceab92">99+</span>  </a><span class="level-item"><i class="far fa-clock"> </i>an hour  <i class="fas fa-pencil-alt"> </i>10.2 k</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>&nbsp;visits</span></div></div><h1 class="title is-3 is-size-4-mobile">Reverse angr</h1><div class="content"><p>[Toc]</p>
<span id="more"></span>
<h2 id="符号执行"><a href="#符号执行" class="headerlink" title="符号执行"></a>符号执行</h2><p>符号执行就是在运行程序时，用符号来替代真实值。符号执行相较于真实值执行的优点在于，当使用真实值执行程序时，我们能够遍历的程序路径只有一条, 而使用符号进行执行时，由于符号是可变的，我们就可以利用这一特性，尽可能的将程序的每一条路径遍历，这样的话，必定存在至少一条能够输出正确结果的分支, 每一条分支的结果都可以表示为一个离散关系式,使用约束求解引擎即可分析出正确结果。</p>
<h2 id="Angr"><a href="#Angr" class="headerlink" title="Angr"></a>Angr</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45225566/article/details/112432388">(31条消息) kali中angr的安装步骤_流风_霜的博客-CSDN博客</a></p>
<p>安装好后通过命令 <strong>source venv/bin/activate</strong> 进入虚拟环境中，即可使用angr</p>
<h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><h4 id="新建一个工程"><a href="#新建一个工程" class="headerlink" title="新建一个工程"></a>新建一个工程</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line">proj=angr.Project(<span class="string">&#x27;/bin/true&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>然后可以得到二进制文件的信息，如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">proj.filename <span class="comment">#文件名</span></span><br><span class="line">proj.arch <span class="comment">#一个archinfo.Arch对象</span></span><br><span class="line"><span class="built_in">hex</span>(proj.entry) <span class="comment">#入口点 &#x27;0x401370&#x27;</span></span><br></pre></td></tr></table></figure>
<p>通常在创建工程时选择关闭auto_load_libs以避免angr加载共享库：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p=angr.Project(&#x27;/bin/true&#x27;,auto_load_libs=False)</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>如果<code>auto_load_libs</code>是<code>True</code>（默认值），真正的库函数会被执行。这可能正是也可能不是你想要的，取决于具体的函数。比如说一些libc的函数分析起来过于复杂并且很有可能引起path对其的尝试执行过程中的state数量的爆炸增长</li>
<li>如果<code>auto_load_libs</code>是<code>False</code>，且外部函数是无法找到的，并且Project会将它们引用到一个通用的叫做<code>ReturnUnconstrained</code>的<code>SimProcedure</code>上去，它就像它的名字所说的那样：它返回一个不受约束的值</li>
</ul>
</blockquote>
<h4 id="设置state"><a href="#设置state" class="headerlink" title="设置state"></a>设置state</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initial_state=project.factory.entry_state()</span><br></pre></td></tr></table></figure>
<p>state代表程序的一个实例镜像，模拟执行某个时刻的状态，就类似于<strong>快照</strong>。保存运行状态的上下文信息，如内存/寄存器等,我们这里使用<code>project.factory.entry_state()</code>告诉符号执行引擎从程序的入口点开始符号执行，除了使用<code>.entry_state()</code> 创建 state 对象, 我们还可以根据需要使用其他构造函数创建 state</p>
<p>除了使用<code>.entry_state()</code> 创建 state 对象, 我们还可以根据需要使用其他构造函数创建 state:</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.entry_state()</code></td>
<td>构造一个已经准备好从函数入口点执行的状态</td>
</tr>
<tr>
<td><code>.blank_state</code></td>
<td>构造一个“空状态”，它的大多数数据都是未初始化的。当使用未初始化的的数据时，一个不受约束的符号值将会被返回</td>
</tr>
<tr>
<td><code>.call_state</code></td>
<td>构造一个已经准备好执行某个函数的状态</td>
</tr>
<tr>
<td><code>.full_init_state</code></td>
<td>构造一个已经执行过所有与需要执行的初始化函数，并准备从函数入口点执行的状态。比如，共享库构造函数（constructor）或预初始化器。当这些执行完之后，程序将会跳到入口点</td>
</tr>
</tbody>
</table>
</div>
<h4 id="设置-Simulation-Managers"><a href="#设置-Simulation-Managers" class="headerlink" title="设置 Simulation Managers"></a>设置 Simulation Managers</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simulation = project.factory.simgr(initial_state)</span><br></pre></td></tr></table></figure>
<p>Project 对象仅表示程序一开始的样子，而在执行时，我们实际上是对SimState对象进行操作，它代表程序的一个实例镜像，模拟执行某个时刻的状态</p>
<p><code>SimState</code> 对象包含程序运行时信息，如内存/寄存器/文件系统数据等。SM（Simulation Managers）是angr中最重要的控制接口，它使你能够同时控制一组状态(state)的符号执行，应用搜索策略来探索程序的状态空间。</p>
<p>模拟管理器具有不同的探索策略，默认策略为广度优先搜索，使用不同的探索策略可以通过调用 <code>simgr.use_technique(tech)</code> 来实现，其中 tech 是一个 ExplorationTechnique 子类的实例，angr 内置的探索技术在 <code>angr.exploration_techniques</code> 下</p>
<ul>
<li><code>Explorer</code>：该技术实现了 <code>.explore()</code> 功能，允许在探索时查找或避免某些地址。</li>
<li><code>DFS</code>：深度优先搜索，每次只探索一条路径，其它路径会放到 <code>deferred</code> stash 中。直到当前路径探索结束，再从 <code>deferred</code> 中取出最长的一条继续探索。</li>
<li><code>LoopLimiter</code>：限制路径的循环次数，超出限制的路径将被放到 <code>discard</code> stash 中。</li>
<li><code>LengthLimiter</code>：限制路径的最大长度</li>
<li><code>ManualMergepoint</code>：将程序中的某个地址标记为合并点，将在一定时间范围内到达的所有 state 合并在一起。</li>
<li><code>Veritesting</code>：是<a target="_blank" rel="noopener" href="https://users.ece.cmu.edu/~aavgerin/papers/veritesting-icse-2014.pdf">这篇论文</a>的实现，试图识别出有用的合并点来解决路径爆炸问题。在创建 SimulationManager 时通过 <code>veritesting=True</code> 来开启。</li>
<li><code>Tracer</code>：记录在某个具体输入下的执行路径，结果是执行完最后一个 basic block 的 state，存放在 <code>traced</code> stash 中。</li>
<li><code>Oppologist</code>：当遇到某个不支持的指令时，它将具体化该指令的所有输入并使用 unicorn engine 继续执行。</li>
<li><code>Threading</code>：将线程级并行添加到探索过程中。</li>
<li><code>Spiller</code>：当处于 active 的 state 过多时，将其中一些转存到磁盘上以保持较低的内存消耗。</li>
</ul>
<h4 id="运行，探索满足路径需要的值"><a href="#运行，探索满足路径需要的值" class="headerlink" title="运行，探索满足路径需要的值"></a>运行，探索满足路径需要的值</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simulation.explore=(find=your_address)</span><br></pre></td></tr></table></figure>
<p>符号执行最普遍的操作是找到能够到达某个地址的状态，同时丢弃其他不能到达这个地址的状态。SM为使用这种执行模式提供了<code>.explore()</code>方法</p>
<p>当使用<code>find</code>参数启动<code>.explore()</code>方法时，程序将会一直执行，直到发现了一个和<code>find</code>参数指定的条件相匹配的状态。<code>find</code>参数的内容可以是想要执行到的某个地址、或者想要执行到的地址列表、或者一个获取state作为参数并判断这个state是否满足某些条件的函数。当<code>active</code>stash中的任意状态和<code>find</code>中的条件匹配的时候，它们就会被放到<code>found stash</code>中，执行随即停止。之后你可以探索找到的状态，或者决定丢弃它，转而探索其它状态。</p>
<h4 id="获取执行结果"><a href="#获取执行结果" class="headerlink" title="获取执行结果"></a>获取执行结果</h4><p>当找到匹配的条件的时候，相关的状态被保存在<code>simgr</code>当中，我们可以通过<code>simgr.found</code>来访问所有符合条件的分支</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]  <span class="comment"># 获取通过 explore 找到符合条件的状态</span></span><br><span class="line">        solution = solution_state.posix.dumps(sys.stdin.fileno())</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] Success! Solution is: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(solution.decode(<span class="string">&quot;utf-8&quot;</span>)))</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="位向量-bitvector"><a href="#位向量-bitvector" class="headerlink" title="位向量(bitvector)"></a>位向量(bitvector)</h4><p>更准确的说是符号位向量，符号位向量是angr用于将符号值注入程序的数据类型。这些将是angr将解决的方程式的“ x”，也就是约束求解时的自变量。可以通过 <code>BVV(value,size)</code> 和 <code>BVS( name, size)</code> 接口创建位向量，也可以用 FPV 和 FPS 来创建浮点值和符号</p>
<p>这里使用BVS生成了一个位向量，此方法有两个参数：第一个是angr用来引用位向量的名称，第二个是位向量的大小（以bit为单位）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">size_in_bits=<span class="number">32</span></span><br><span class="line">x=claripy.BVS(<span class="string">&#x27;x&#x27;</span>, size_in_bits)</span><br></pre></td></tr></table></figure>
<h4 id="访问寄存器"><a href="#访问寄存器" class="headerlink" title="访问寄存器"></a>访问寄存器</h4><p>可以通过statr.regs对象的属性来访问或修改寄存器的数据，例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initial_state.regs.eax=passwd0</span><br></pre></td></tr></table></figure>
<h4 id="eval"><a href="#eval" class="headerlink" title="eval"></a>eval</h4><ul>
<li><code>solver.eval(expression)</code> 将会解出一个可行解</li>
<li><code>solver.eval_one(expression)</code>将会给出一个表达式的可行解，若有多个可行解，则抛出异常。</li>
<li><code>solver.eval_upto(expression, n)</code>将会给出最多n个可行解，如果不足n个就给出所有的可行解。</li>
<li><code>solver.eval_exact(expression, n)</code>将会给出n个可行解，如果解的个数不等于n个，将会抛出异常。</li>
<li><code>solver.min(expression)</code>将会给出最小可行解</li>
<li><code>solver.max(expression)</code>将会给出最大可行解</li>
</ul>
<p>另外还有还有<code>cast_to</code>可以接收一个参数来指定把结果映射到哪种数据类型。目前这个参数只能是<code>str</code>，它将会以字符串形式展示返回的结果</p>
<h4 id="Hook"><a href="#Hook" class="headerlink" title="Hook"></a>Hook</h4><blockquote>
<p><strong>钩子编程</strong>（hooking），也称作“挂钩”，是计算机程序设计术语，指通过拦截软件模块间的函数调用、消息传递、事件传递来修改或扩展操作系统、应用程序或其他软件组件的行为的各种技术。处理被拦截的函数调用、事件、消息的代码，被称为<strong>钩子</strong>（hook）。</p>
<p>简单来说就是用我们自己设计的函数去取代被hook的函数</p>
</blockquote>
<p>一个简单的例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@project.hook(<span class="params"><span class="number">0x1234</span>,length=<span class="number">5</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_rax</span>(<span class="params">state</span>):</span></span><br><span class="line">	state.regs.rax=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<h4 id="Hooking-Symbols"><a href="#Hooking-Symbols" class="headerlink" title="Hooking Symbols"></a>Hooking Symbols</h4><p>每一个程序都有一个符号表，angr可以确保从每个导入符号都可以解析出地址，可以使用angr提供的<code>Project.hook_symbol</code>API来通过符号名来Hook函数所有的调用地址，这意味着可以用自己的代码替换函数，一个简单的例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; class NotVeryRand(SimProcedure):</span><br><span class="line">...     def run(self, return_values=None):</span><br><span class="line">...         rand_idx = self.state.globals.get(&#x27;rand_idx&#x27;, 0) % len(return_values)</span><br><span class="line">...         out = return_values[rand_idx]</span><br><span class="line">...         self.state.globals[&#x27;rand_idx&#x27;] = rand_idx + 1</span><br><span class="line">...         return out</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; project.hook_symbol(&#x27;rand&#x27;, NotVeryRand(return_values=[413, 612, 1025, 1111]))</span><br></pre></td></tr></table></figure>
<h4 id="pre-binary-选项"><a href="#pre-binary-选项" class="headerlink" title="pre-binary 选项"></a>pre-binary 选项</h4><p>如果你想要对一个特定的二进制对象设置一些选项，CLE也能满足你的需求在加载二进制文件时可以设置特定的参数，使用 <code>main_opts</code> 和 <code>lib_opts</code> 参数进行设置。</p>
<ul>
<li><code>backend</code> - 指定 backend</li>
<li><code>base_addr</code> - 指定基址</li>
<li><code>entry_point</code> - 指定入口点</li>
<li><code>arch</code> - 指定架构</li>
</ul>
<p>示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; angr.Project(&#x27;examples/fauxware/fauxware&#x27;, main_opts=&#123;&#x27;backend&#x27;: &#x27;blob&#x27;, &#x27;arch&#x27;: &#x27;i386&#x27;&#125;, lib_opts=&#123;&#x27;libc.so.6&#x27;: &#123;&#x27;backend&#x27;: &#x27;elf&#x27;&#125;&#125;)</span><br><span class="line">&lt;Project examples/fauxware/fauxware&gt;</span><br></pre></td></tr></table></figure>
<p>参数<code>main_opts</code>和<code>lib_opts</code>接收一个以python字典形式存储的选项组。<code>main_opts</code>接收一个形如{选项名1：选项值1，选项名2：选项值2……}的字典，而<code>lib_opts</code>接收一个库名到形如{选项名1:选项值1，选项名2:选项值2……}的字典的映射。</p>
<blockquote>
<p>lib_opts是二级字典，原因是一个二进制文件可能加载多个库，而main_opts指定的是主程序加载参数，而主程序一般只有一个，因此是一级字典。</p>
</blockquote>
<p>这些选项的内容因不同的后台而异，下面是一些通用的选项：</p>
<ul>
<li>backend —— 使用哪个后台，可以是一个对象，也可以是一个名字(字符串)</li>
<li>custom_base_addr —— 使用的基地址</li>
<li>custom_entry_point —— 使用的入口点</li>
<li>custom_arch —— 使用的处理器体系结构的名字</li>
</ul>
<h2 id="题目-from-angr-CTF"><a href="#题目-from-angr-CTF" class="headerlink" title="题目 from angr CTF"></a>题目 from angr CTF</h2><p>题目来源：<a target="_blank" rel="noopener" href="http://angr.oregonctf.org/download/">angr CTF (oregonctf.org)</a> </p>
<h3 id="00-angr-find"><a href="#00-angr-find" class="headerlink" title="00_angr_find"></a>00_angr_find</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line"></span><br><span class="line">  path_to_binary = <span class="string">&#x27;00_angr_find&#x27;</span>  <span class="comment"># :string</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  print_good_address = <span class="number">0x080492f8</span>  <span class="comment"># :integer (probably in hexadecimal)</span></span><br><span class="line">  simulation.explore(find=print_good_address)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line"></span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="01-angr-avoid"><a href="#01-angr-avoid" class="headerlink" title="01_angr_avoid"></a>01_angr_avoid</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = <span class="string">&#x27;01_angr_avoid&#x27;</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  print_good_address = <span class="number">0x08049300</span></span><br><span class="line">  will_not_succeed_address = <span class="number">0x080492bb</span></span><br><span class="line">  simulation.explore(find=print_good_address, avoid=will_not_succeed_address)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="02-angr-find-condition"><a href="#02-angr-find-condition" class="headerlink" title="02_angr_find_condition"></a>02_angr_find_condition</h3><p>通过程序输出判断是否符合条件（此题把第一题改一改也能过，但这样就没意思了）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = <span class="string">&#x27;02_angr_find_condition&#x27;</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line"><span class="comment"># Dump whatever has been printed out by the binary so far into a string.</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Return whether &#x27;Good Job.&#x27; has been printed yet.</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    <span class="keyword">return</span> stdout_output==<span class="string">b&#x27;Enter the password: Good Job.\n&#x27;</span>  <span class="comment"># :boolean</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> stdout_output==<span class="string">b&#x27;Enter the password: Try again.\n&#x27;</span>  <span class="comment"># :boolean</span></span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="03-angr-simbolic-registers"><a href="#03-angr-simbolic-registers" class="headerlink" title="03_angr_simbolic_registers"></a>03_angr_simbolic_registers</h3><p>angr在处理scanf等复杂输入时不太方便，此时将入口地址设置为输入函数之后，通过符号化寄存器来获得理想输入</p>
<p>看一下汇编，输入的三个参数分别放在eax,ebx,edx三个寄存器中，我们需要符号化这三个寄存器</p>
<img src="/2022/05/09/Reverse-angr/image-20220505162352974.png" class title="image-20220505162352974">
<p>但是对于为什么在scanf执行后需要重设ebp=esp仍有不太理解…</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"># Angr doesn&#x27;t currently support reading multiple things with scanf (Ex: </span><br><span class="line"># scanf(&quot;%u %u).) You will have to tell the simulation engine to begin the</span><br><span class="line"># program after scanf is called and manually inject the symbols into registers.</span><br><span class="line"></span><br><span class="line">import angr</span><br><span class="line">import claripy</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">def main(argv):</span><br><span class="line">  path_to_binary = &#x27;03_angr_symbolic_registers&#x27;</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  # Sometimes, you want to specify where the program should start. The variable</span><br><span class="line">  # start_address will specify where the symbolic execution engine should begin.</span><br><span class="line">  # Note that we are using blank_state, not entry_state.</span><br><span class="line">  # (!)</span><br><span class="line">  start_address = 0x08049626  # :integer (probably hexadecimal)</span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  # Create a symbolic bitvector (the datatype Angr uses to inject symbolic</span><br><span class="line">  # values into the binary.) The first parameter is just a name Angr uses</span><br><span class="line">  # to reference it. </span><br><span class="line">  # You will have to construct multiple bitvectors. Copy the two lines below</span><br><span class="line">  # and change the variable names. To figure out how many (and of what size)</span><br><span class="line">  # you need, dissassemble the binary and determine the format parameter passed</span><br><span class="line">  # to scanf.</span><br><span class="line">  # (!)</span><br><span class="line">  password0_size_in_bits = 32  # :integer</span><br><span class="line">  password0 = claripy.BVS(&#x27;password0&#x27;, password0_size_in_bits)</span><br><span class="line">  password1_size_in_bits = 32  # :integer</span><br><span class="line">  password1 = claripy.BVS(&#x27;password0&#x27;, password1_size_in_bits)</span><br><span class="line">  password2_size_in_bits = 32  # :integer</span><br><span class="line">  password2 = claripy.BVS(&#x27;password0&#x27;, password2_size_in_bits)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  # Set a register to a symbolic value. This is one way to inject symbols into</span><br><span class="line">  # the program.</span><br><span class="line">  # initial_state.regs stores a number of convenient attributes that reference</span><br><span class="line">  # registers by name. For example, to set eax to password0, use:</span><br><span class="line">  #</span><br><span class="line">  # initial_state.regs.eax = password0</span><br><span class="line">  #</span><br><span class="line">  # You will have to set multiple registers to distinct bitvectors. Copy and</span><br><span class="line">  # paste the line below and change the register. To determine which registers</span><br><span class="line">  # to inject which symbol, dissassemble the binary and look at the instructions</span><br><span class="line">  # immediately following the call to scanf.</span><br><span class="line">  # (!)</span><br><span class="line">  initial_state.regs.eax = password0</span><br><span class="line">  initial_state.regs.ebx = password1</span><br><span class="line">  initial_state.regs.edx = password2</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  def is_successful(state):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    return b&#x27;Good Job.&#x27; in stdout_output</span><br><span class="line"></span><br><span class="line">  def should_abort(state):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    return b&#x27;Try again.&#x27; in stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  if simulation.found:</span><br><span class="line">    solution_state = simulation.found[0]</span><br><span class="line"></span><br><span class="line">    # Solve for the symbolic values. If there are multiple solutions, we only</span><br><span class="line">    # care about one, so we can use eval, which returns any (but only one)</span><br><span class="line">    # solution. Pass eval the bitvector you want to solve for.</span><br><span class="line">    # (!)</span><br><span class="line">    solution0 = solution_state.solver.eval(password0)</span><br><span class="line">    solution1 = solution_state.solver.eval(password1)</span><br><span class="line">    solution2 = solution_state.solver.eval(password2)</span><br><span class="line"></span><br><span class="line">    # Aggregate and format the solutions you computed above, and then print</span><br><span class="line">    # the full string. Pay attention to the order of the integers, and the</span><br><span class="line">    # expected base (decimal, octal, hexadecimal, etc).</span><br><span class="line">    solution = hex(solution0)[2:]+&#x27; &#x27;+hex(solution1)[2:]+&#x27; &#x27;+hex(solution2)[2:]  # :string</span><br><span class="line">    print(solution)</span><br><span class="line">  else:</span><br><span class="line">    raise Exception(&#x27;Could not find the solution&#x27;)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="04-angr-symbolic-stack"><a href="#04-angr-symbolic-stack" class="headerlink" title="04_angr_symbolic_stack"></a>04_angr_symbolic_stack</h3><p>符号化栈</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"># This challenge will be more challenging than the previous challenges that you</span><br><span class="line"># have encountered thus far. Since the goal of this CTF is to teach symbolic</span><br><span class="line"># execution and not how to construct stack frames, these comments will work you</span><br><span class="line"># through understanding what is on the stack.</span><br><span class="line">#   ! ! !</span><br><span class="line"># IMPORTANT: Any addresses in this script aren&#x27;t necessarily right! Dissassemble</span><br><span class="line">#            the binary yourself to determine the correct addresses!</span><br><span class="line">#   ! ! !</span><br><span class="line"></span><br><span class="line">import angr</span><br><span class="line">import claripy</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">def main(argv):</span><br><span class="line">  path_to_binary = &#x27;04_angr_symbolic_stack&#x27;</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  # For this challenge, we want to begin after the call to scanf. Note that this</span><br><span class="line">  # is in the middle of a function.</span><br><span class="line">  #</span><br><span class="line">  # This challenge requires dealing with the stack, so you have to pay extra</span><br><span class="line">  # careful attention to where you start, otherwise you will enter a condition</span><br><span class="line">  # where the stack is set up incorrectly. In order to determine where after</span><br><span class="line">  # scanf to start, we need to look at the dissassembly of the call and the</span><br><span class="line">  # instruction immediately following it:</span><br><span class="line">  #   sub    $0x4,%esp</span><br><span class="line">  #   lea    -0x10(%ebp),%eax</span><br><span class="line">  #   push   %eax</span><br><span class="line">  #   lea    -0xc(%ebp),%eax</span><br><span class="line">  #   push   %eax</span><br><span class="line">  #   push   $0x80489c3</span><br><span class="line">  #   call   8048370 &lt;__isoc99_scanf@plt&gt;</span><br><span class="line">  #   add    $0x10,%esp</span><br><span class="line">  # Now, the question is: do we start on the instruction immediately following</span><br><span class="line">  # scanf (add $0x10,%esp), or the instruction following that (not shown)?</span><br><span class="line">  # Consider what the &#x27;add $0x10,%esp&#x27; is doing. Hint: it has to do with the</span><br><span class="line">  # scanf parameters that are pushed to the stack before calling the function.</span><br><span class="line">  # Given that we are not calling scanf in our Angr simulation, where should we</span><br><span class="line">  # start?</span><br><span class="line">  # (!)</span><br><span class="line">  start_address = 0x080493f2</span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  # We are jumping into the middle of a function! Therefore, we need to account</span><br><span class="line">  # for how the function constructs the stack. The second instruction of the</span><br><span class="line">  # function is:</span><br><span class="line">  #   mov    %esp,%ebp</span><br><span class="line">  # At which point it allocates the part of the stack frame we plan to target:</span><br><span class="line">  #   sub    $0x18,%esp</span><br><span class="line">  # Note the value of esp relative to ebp. The space between them is (usually)</span><br><span class="line">  # the stack space. Since esp was decreased by 0x18</span><br><span class="line">  #</span><br><span class="line">  #        /-------- The stack --------\</span><br><span class="line">  # ebp -&gt; |                           |</span><br><span class="line">  #        |---------------------------|</span><br><span class="line">  #        |                           |</span><br><span class="line">  #        |---------------------------|</span><br><span class="line">  #         . . . (total of 0x18 bytes)</span><br><span class="line">  #         . . . Somewhere in here is</span><br><span class="line">  #         . . . the data that stores</span><br><span class="line">  #         . . . the result of scanf.</span><br><span class="line">  # esp -&gt; |                           |</span><br><span class="line">  #        \---------------------------/</span><br><span class="line">  #</span><br><span class="line">  # Since we are starting after scanf, we are skipping this stack construction</span><br><span class="line">  # step. To make up for this, we need to construct the stack ourselves. Let us</span><br><span class="line">  # start by initializing ebp in the exact same way the program does.</span><br><span class="line">  initial_state.regs.ebp = initial_state.regs.esp</span><br><span class="line"></span><br><span class="line">  # scanf(&quot;%u %u&quot;) needs to be replaced by injecting two bitvectors. The</span><br><span class="line">  # reason for this is that Angr does not (currently) automatically inject</span><br><span class="line">  # symbols if scanf has more than one input parameter. This means Angr can</span><br><span class="line">  # handle &#x27;scanf(&quot;%u&quot;)&#x27;, but not &#x27;scanf(&quot;%u %u&quot;)&#x27;.</span><br><span class="line">  # You can either copy and paste the line below or use a Python list.</span><br><span class="line">  # (!)</span><br><span class="line">  password0 = claripy.BVS(&#x27;password0&#x27;, 32)</span><br><span class="line">  password1 = claripy.BVS(&#x27;password1&#x27;, 32)</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  # Here is the hard part. We need to figure out what the stack looks like, at</span><br><span class="line">  # least well enough to inject our symbols where we want them. In order to do</span><br><span class="line">  # that, let&#x27;s figure out what the parameters of scanf are:</span><br><span class="line">  #   sub    $0x4,%esp</span><br><span class="line">  #   lea    -0x10(%ebp),%eax</span><br><span class="line">  #   push   %eax</span><br><span class="line">  #   lea    -0xc(%ebp),%eax</span><br><span class="line">  #   push   %eax</span><br><span class="line">  #   push   $0x80489c3</span><br><span class="line">  #   call   8048370 &lt;__isoc99_scanf@plt&gt;</span><br><span class="line">  #   add    $0x10,%esp </span><br><span class="line">  # As you can see, the call to scanf looks like this:</span><br><span class="line">  # scanf(  0x80489c3,   ebp - 0xc,   ebp - 0x10  )</span><br><span class="line">  #      format_string    password0    password1</span><br><span class="line">  #  From this, we can construct our new, more accurate stack diagram:</span><br><span class="line">  #</span><br><span class="line">  #            /-------- The stack --------\</span><br><span class="line">  # ebp -&gt;     |          padding          |</span><br><span class="line">  #            |---------------------------|</span><br><span class="line">  # ebp - 0x01 |       more padding        |</span><br><span class="line">  #            |---------------------------|</span><br><span class="line">  # ebp - 0x02 |     even more padding     |</span><br><span class="line">  #            |---------------------------|</span><br><span class="line">  #                        . . .               &lt;- How much padding? Hint: how</span><br><span class="line">  #            |---------------------------|      many bytes is password0?</span><br><span class="line">  # ebp - 0x0b |   password0, second byte  |</span><br><span class="line">  #            |---------------------------|</span><br><span class="line">  # ebp - 0x0c |   password0, first byte   |</span><br><span class="line">  #            |---------------------------|</span><br><span class="line">  # ebp - 0x0d |   password1, last byte    |</span><br><span class="line">  #            |---------------------------|</span><br><span class="line">  #                        . . .</span><br><span class="line">  #            |---------------------------|</span><br><span class="line">  # ebp - 0x10 |   password1, first byte   |</span><br><span class="line">  #            |---------------------------|</span><br><span class="line">  #                        . . .</span><br><span class="line">  #            |---------------------------|</span><br><span class="line">  # esp -&gt;     |                           |</span><br><span class="line">  #            \---------------------------/</span><br><span class="line">  #</span><br><span class="line">  # Figure out how much space there is and allocate the necessary padding to</span><br><span class="line">  # the stack by decrementing esp before you push the password bitvectors.</span><br><span class="line">  padding_length_in_bytes = 8  # :integer</span><br><span class="line">  initial_state.regs.esp -= padding_length_in_bytes</span><br><span class="line"></span><br><span class="line">  # Push the variables to the stack. Make sure to push them in the right order!</span><br><span class="line">  # The syntax for the following function is:</span><br><span class="line">  #</span><br><span class="line">  # initial_state.stack_push(bitvector)</span><br><span class="line">  #</span><br><span class="line">  # This will push the bitvector on the stack, and increment esp the correct</span><br><span class="line">  # amount. You will need to push multiple bitvectors on the stack.</span><br><span class="line">  # (!)</span><br><span class="line">  initial_state.stack_push(password1)  # :bitvector (claripy.BVS, claripy.BVV, claripy.BV)</span><br><span class="line">  initial_state.stack_push(password0)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  def is_successful(state):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    return b&#x27;Good Job.&#x27; in stdout_output</span><br><span class="line"></span><br><span class="line">  def should_abort(state):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    return b&#x27;Try again.&#x27; in stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  if simulation.found:</span><br><span class="line">    solution_state = simulation.found[0]</span><br><span class="line"></span><br><span class="line">    solution0 = solution_state.solver.eval(password0)</span><br><span class="line">    solution1 = solution_state.solver.eval(password1)</span><br><span class="line"></span><br><span class="line">    solution = str(solution1)+&#x27; &#x27;+str(solution0)</span><br><span class="line">    print(solution)</span><br><span class="line">  else:</span><br><span class="line">    raise Exception(&#x27;Could not find the solution&#x27;)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="05-angr-symbolic-memory"><a href="#05-angr-symbolic-memory" class="headerlink" title="05_angr_symbolic_memory"></a>05_angr_symbolic_memory</h3><p>内存符号化，取输入内容所存放的地址，然后将符号存到这个地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = <span class="string">&#x27;05_angr_symbolic_memory&#x27;</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  start_address = <span class="number">0x08049315</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># The binary is calling scanf(&quot;%8s %8s %8s %8s&quot;).</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, <span class="number">64</span>)</span><br><span class="line">  password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, <span class="number">64</span>)</span><br><span class="line">  password2 = claripy.BVS(<span class="string">&#x27;password2&#x27;</span>, <span class="number">64</span>)</span><br><span class="line">  password3 = claripy.BVS(<span class="string">&#x27;password3&#x27;</span>, <span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Determine the address of the global variable to which scanf writes the user</span></span><br><span class="line">  <span class="comment"># input. The function &#x27;initial_state.memory.store(address, value)&#x27; will write</span></span><br><span class="line">  <span class="comment"># &#x27;value&#x27; (a bitvector) to &#x27;address&#x27; (a memory location, as an integer.) The</span></span><br><span class="line">  <span class="comment"># &#x27;address&#x27; parameter can also be a bitvector (and can be symbolic!).</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  password0_address = <span class="number">0x09cdc1a0</span></span><br><span class="line">  initial_state.memory.store(password0_address, password0)</span><br><span class="line">  password1_address = <span class="number">0x09cdc1a8</span></span><br><span class="line">  initial_state.memory.store(password1_address, password1)</span><br><span class="line">  password2_address = <span class="number">0x09cdc1b0</span></span><br><span class="line">  initial_state.memory.store(password2_address, password2)</span><br><span class="line">  password3_address = <span class="number">0x09cdc1b8</span></span><br><span class="line">  initial_state.memory.store(password3_address, password3)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Solve for the symbolic values. We are trying to solve for a string.</span></span><br><span class="line">    <span class="comment"># Therefore, we will use eval, with named parameter cast_to=bytes</span></span><br><span class="line">    <span class="comment"># which returns bytes that can be decoded to a string instead of an integer.</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(password0,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(password1,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution2 = solution_state.solver.<span class="built_in">eval</span>(password2,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution3 = solution_state.solver.<span class="built_in">eval</span>(password3,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution = solution0+solution1+solution2+solution3</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="06-angr-symbolic-dynamic-memory"><a href="#06-angr-symbolic-dynamic-memory" class="headerlink" title="06_angr_symbolic_dynamic_memory"></a>06_angr_symbolic_dynamic_memory</h3><p>这题使用了malloc来分配内存，因此需要使用符号化动态内存</p>
<p>而与其获得每一次malloc分配的地址，不如直接虚构一个假地址，并将这个假地址写入内存指针</p>
<blockquote>
<p>回到我们最开始认识angr的时候，我们知道angr并没有真正“运行”二进制文件（至少到目前为止），它只是在模拟运行状态，因此它实际上不需要将内存分配到堆中，实际上可以伪造任何地址。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = <span class="string">&#x27;06_angr_symbolic_dynamic_memory&#x27;</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  start_address = <span class="number">0x0804938c</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># The binary is calling scanf(&quot;%8s %8s&quot;).</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, <span class="number">64</span>)</span><br><span class="line">  password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, <span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Instead of telling the binary to write to the address of the memory</span></span><br><span class="line">  <span class="comment"># allocated with malloc, we can simply fake an address to any unused block of</span></span><br><span class="line">  <span class="comment"># memory and overwrite the pointer to the data. This will point the pointer</span></span><br><span class="line">  <span class="comment"># with the address of pointer_to_malloc_memory_address0 to fake_heap_address.</span></span><br><span class="line">  <span class="comment"># Be aware, there is more than one pointer! Analyze the binary to determine</span></span><br><span class="line">  <span class="comment"># global location of each pointer.</span></span><br><span class="line">  <span class="comment"># Note: by default, Angr stores integers in memory with big-endianness. To</span></span><br><span class="line">  <span class="comment"># specify to use the endianness of your architecture, use the parameter</span></span><br><span class="line">  <span class="comment"># endness=project.arch.memory_endness. On x86, this is little-endian.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  fake_heap_address0 = <span class="number">0x08094035</span></span><br><span class="line">  pointer_to_malloc_memory_address0 = <span class="number">0x09ec4c94</span></span><br><span class="line">  initial_state.memory.store(pointer_to_malloc_memory_address0, fake_heap_address0, endness=project.arch.memory_endness)</span><br><span class="line">  fake_heap_address1 = <span class="number">0x08094055</span></span><br><span class="line">  pointer_to_malloc_memory_address1 = <span class="number">0x09ec4c9c</span></span><br><span class="line">  initial_state.memory.store(pointer_to_malloc_memory_address1, fake_heap_address1, endness=project.arch.memory_endness)</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  <span class="comment"># Store our symbolic values at our fake_heap_address. Look at the binary to</span></span><br><span class="line">  <span class="comment"># determine the offsets from the fake_heap_address where scanf writes.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  initial_state.memory.store(fake_heap_address0, password0)</span><br><span class="line">  initial_state.memory.store(fake_heap_address1, password1)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(password0,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(password1,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution = solution0+solution1</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="07-angr-symbolic-file"><a href="#07-angr-symbolic-file" class="headerlink" title="07_angr_symbolic_file"></a>07_angr_symbolic_file</h3><p>此题需要读取一个文件作为密码，因此我们需要利用angr的文件系统模拟出一个文件，从而进行符号化处理</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This challenge could, in theory, be solved in multiple ways. However, for the</span></span><br><span class="line"><span class="comment"># sake of learning how to simulate an alternate filesystem, please solve this</span></span><br><span class="line"><span class="comment"># challenge according to structure provided below. As a challenge, once you have</span></span><br><span class="line"><span class="comment"># an initial solution, try solving this in an alternate way.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Problem description and general solution strategy:</span></span><br><span class="line"><span class="comment"># The binary loads the password from a file using the fread function. If the</span></span><br><span class="line"><span class="comment"># password is correct, it prints &quot;Good Job.&quot; In order to keep consistency with</span></span><br><span class="line"><span class="comment"># the other challenges, the input from the console is written to a file in the </span></span><br><span class="line"><span class="comment"># ignore_me function. As the name suggests, ignore it, as it only exists to</span></span><br><span class="line"><span class="comment"># maintain consistency with other challenges.</span></span><br><span class="line"><span class="comment"># We want to:</span></span><br><span class="line"><span class="comment"># 1. Determine the file from which fread reads.</span></span><br><span class="line"><span class="comment"># 2. Use Angr to simulate a filesystem where that file is replaced with our own</span></span><br><span class="line"><span class="comment">#    simulated file.</span></span><br><span class="line"><span class="comment"># 3. Initialize the file with a symbolic value, which will be read with fread</span></span><br><span class="line"><span class="comment">#    and propogated through the program.</span></span><br><span class="line"><span class="comment"># 4. Solve for the symbolic input to determine the password.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = <span class="string">&#x27;07_angr_symbolic_file&#x27;</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  start_address = <span class="number">0x08049550</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Specify some information needed to construct a simulated file. For this</span></span><br><span class="line">  <span class="comment"># challenge, the filename is hardcoded, but in theory, it could be symbolic. </span></span><br><span class="line">  <span class="comment"># Note: to read from the file, the binary calls</span></span><br><span class="line">  <span class="comment"># &#x27;fread(buffer, sizeof(char), 64, file)&#x27;.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  filename = <span class="string">&#x27;KAZSUXSF.txt&#x27;</span>  <span class="comment"># :string</span></span><br><span class="line">  symbolic_file_size_bytes = <span class="number">0x40</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Construct a bitvector for the password and then store it in the file&#x27;s</span></span><br><span class="line">  <span class="comment"># backing memory. For example, imagine a simple file, &#x27;hello.txt&#x27;:</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Hello world, my name is John.</span></span><br><span class="line">  <span class="comment"># ^                       ^</span></span><br><span class="line">  <span class="comment"># ^ address 0             ^ address 24 (count the number of characters)</span></span><br><span class="line">  <span class="comment"># In order to represent this in memory, we would want to write the string to</span></span><br><span class="line">  <span class="comment"># the beginning of the file:</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># hello_txt_contents = claripy.BVV(&#x27;Hello world, my name is John.&#x27;, 30*8)</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Perhaps, then, we would want to replace John with a</span></span><br><span class="line">  <span class="comment"># symbolic variable. We would call:</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># name_bitvector = claripy.BVS(&#x27;symbolic_name&#x27;, 4*8)</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Then, after the program calls fopen(&#x27;hello.txt&#x27;, &#x27;r&#x27;) and then</span></span><br><span class="line">  <span class="comment"># fread(buffer, sizeof(char), 30, hello_txt_file), the buffer would contain</span></span><br><span class="line">  <span class="comment"># the string from the file, except four symbolic bytes where the name would be</span></span><br><span class="line">  <span class="comment"># stored.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  password = claripy.BVS(<span class="string">&#x27;password&#x27;</span>, symbolic_file_size_bytes * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Construct the symbolic file. The file_options parameter specifies the Linux</span></span><br><span class="line">  <span class="comment"># file permissions (read, read/write, execute etc.) The content parameter</span></span><br><span class="line">  <span class="comment"># specifies from where the stream of data should be supplied. If content is</span></span><br><span class="line">  <span class="comment"># an instance of SimSymbolicMemory (we constructed one above), the stream will</span></span><br><span class="line">  <span class="comment"># contain the contents (including any symbolic contents) of the memory,</span></span><br><span class="line">  <span class="comment"># beginning from address zero.</span></span><br><span class="line">  <span class="comment"># Set the content parameter to our BVS instance that holds the symbolic data.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  password_file = angr.storage.SimFile(filename, content=password)</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Add the symbolic file we created to the symbolic filesystem.</span></span><br><span class="line">  initial_state.fs.insert(filename, password_file)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution = solution_state.solver.<span class="built_in">eval</span>(password,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="08-angr-constraints"><a href="#08-angr-constraints" class="headerlink" title="08_angr_constraints"></a>08_angr_constraints</h3><p>通过添加约束解决路径爆炸问题</p>
<blockquote>
<p>当一个程序存在循环结构时，即使逻辑十分简单也可能会产生规模十分巨大的执行路径。在符号执行的过程中，每个分支点都会产生两个实例，当程序中存在循环结构展开时，可能会导致程序分支路径数呈指数级增长，即路径爆炸问题。故我们需要提供更多的约束条件控制路径爆炸问题</p>
</blockquote>
<p>为了避免路径爆炸，此题在完成求解时并不会进到check_equals_BMCCHUGEIQDYESGO函数中，而是在这之前停住，转而向求解得到的状态中添加约束，使约束向量等于最终的比较值，从而得到符合要求的输入。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The binary asks for a 16 character password to which is applies a complex</span></span><br><span class="line"><span class="comment"># function and then compares with a reference string with the function</span></span><br><span class="line"><span class="comment"># check_equals_[reference string]. (Decompile the binary and take a look at it!)</span></span><br><span class="line"><span class="comment"># The source code for this function is provided here. However, the reference</span></span><br><span class="line"><span class="comment"># string in your version will be different than AABBCCDDEEFFGGHH:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># #define REFERENCE_PASSWORD = &quot;AABBCCDDEEFFGGHH&quot;;</span></span><br><span class="line"><span class="comment"># int check_equals_AABBCCDDEEFFGGHH(char* to_check, size_t length) &#123;</span></span><br><span class="line"><span class="comment">#   uint32_t num_correct = 0;</span></span><br><span class="line"><span class="comment">#   for (int i=0; i&lt;length; ++i) &#123;</span></span><br><span class="line"><span class="comment">#     if (to_check[i] == REFERENCE_PASSWORD[i]) &#123;</span></span><br><span class="line"><span class="comment">#       num_correct += 1;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment">#   &#125;</span></span><br><span class="line"><span class="comment">#   return num_correct == length;</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># char* input = user_input();</span></span><br><span class="line"><span class="comment"># char* encrypted_input = complex_function(input);</span></span><br><span class="line"><span class="comment"># if (check_equals_AABBCCDDEEFFGGHH(encrypted_input, 16)) &#123;</span></span><br><span class="line"><span class="comment">#   puts(&quot;Good Job.&quot;);</span></span><br><span class="line"><span class="comment"># &#125; else &#123;</span></span><br><span class="line"><span class="comment">#   puts(&quot;Try again.&quot;);</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The function checks if *to_check == &quot;AABBCCDDEEFFGGHH&quot;. Verify this yourself.</span></span><br><span class="line"><span class="comment"># While you, as a human, can easily determine that this function is equivalent</span></span><br><span class="line"><span class="comment"># to simply comparing the strings, the computer cannot. Instead the computer </span></span><br><span class="line"><span class="comment"># would need to branch every time the if statement in the loop was called (16 </span></span><br><span class="line"><span class="comment"># times), resulting in 2^16 = 65,536 branches, which will take too long of a </span></span><br><span class="line"><span class="comment"># time to evaluate for our needs.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># We do not know how the complex_function works, but we want to find an input</span></span><br><span class="line"><span class="comment"># that, when modified by complex_function, will produce the string:</span></span><br><span class="line"><span class="comment"># AABBCCDDEEFFGGHH.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In this puzzle, your goal will be to stop the program before this function is</span></span><br><span class="line"><span class="comment"># called and manually constrain the to_check variable to be equal to the</span></span><br><span class="line"><span class="comment"># password you identify by decompiling the binary. Since, you, as a human, know</span></span><br><span class="line"><span class="comment"># that if the strings are equal, the program will print &quot;Good Job.&quot;, you can</span></span><br><span class="line"><span class="comment"># be assured that if the program can solve for an input that makes them equal,</span></span><br><span class="line"><span class="comment"># the input will be the correct password.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = <span class="string">&#x27;08_angr_constraints&#x27;</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  start_address = <span class="number">0x0804935d</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  password = claripy.BVS(<span class="string">&#x27;password&#x27;</span>, <span class="number">128</span>)</span><br><span class="line"></span><br><span class="line">  password_address = <span class="number">0x0804c040</span></span><br><span class="line">  initial_state.memory.store(password_address, password)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Angr will not be able to reach the point at which the binary prints out</span></span><br><span class="line">  <span class="comment"># &#x27;Good Job.&#x27;. We cannot use that as the target anymore.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  address_to_check_constraint = <span class="number">0x080493a9</span></span><br><span class="line">  simulation.explore(find=address_to_check_constraint)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Recall that we need to constrain the to_check parameter (see top) of the </span></span><br><span class="line">    <span class="comment"># check_equals_ function. Determine the address that is being passed as the</span></span><br><span class="line">    <span class="comment"># parameter and load it into a bitvector so that we can constrain it.</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    constrained_parameter_address = <span class="number">0x0804c040</span></span><br><span class="line">    constrained_parameter_size_bytes = <span class="number">16</span></span><br><span class="line">    constrained_parameter_bitvector = solution_state.memory.load(</span><br><span class="line">      constrained_parameter_address,</span><br><span class="line">      constrained_parameter_size_bytes</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># We want to constrain the system to find an input that will make</span></span><br><span class="line">    <span class="comment"># constrained_parameter_bitvector equal the desired value.</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    constrained_parameter_desired_value = <span class="string">&#x27;BMCCHUGEIQDYESGO&#x27;</span> <span class="comment"># :string (encoded)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Specify a claripy expression (using Pythonic syntax) that tests whether</span></span><br><span class="line">    <span class="comment"># constrained_parameter_bitvector == constrained_parameter_desired_value.</span></span><br><span class="line">    <span class="comment"># Add the constraint to the state to let z3 attempt to find an input that</span></span><br><span class="line">    <span class="comment"># will make this expression true.</span></span><br><span class="line">    solution_state.add_constraints(constrained_parameter_bitvector == constrained_parameter_desired_value)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Solve for the constrained_parameter_bitvector.</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    solution = solution_state.solver.<span class="built_in">eval</span>(password,cast_to=<span class="built_in">bytes</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="09-angr-hooks"><a href="#09-angr-hooks" class="headerlink" title="09_angr_hooks"></a>09_angr_hooks</h3><p>学习使用angr的hook技术解决路径爆炸问题</p>
<blockquote>
<p><strong>钩子编程</strong>（hooking），也称作“挂钩”，是计算机程序设计术语，指通过拦截软件模块间的函数调用、消息传递、事件传递来修改或扩展操作系统、应用程序或其他软件组件的行为的各种技术。处理被拦截的函数调用、事件、消息的代码，被称为<strong>钩子</strong>（hook）。</p>
<p>简单来说就是用我们自己设计的函数去取代被hook的函数</p>
</blockquote>
<p>在本题中需要用自己设计的skip_check_equals函数替代check_equals_函数</p>
<p>注意user_input_buffer_length要设置正确</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This level performs the following computations:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 1. Get 16 bytes of user input and encrypt it.</span></span><br><span class="line"><span class="comment"># 2. Save the result of check_equals_AABBCCDDEEFFGGHH (or similar)</span></span><br><span class="line"><span class="comment"># 3. Get another 16 bytes from the user and encrypt it.</span></span><br><span class="line"><span class="comment"># 4. Check that it&#x27;s equal to a predefined password.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The ONLY part of this program that we have to worry about is #2. We will be</span></span><br><span class="line"><span class="comment"># replacing the call to check_equals_ with our own version, using a hook, since</span></span><br><span class="line"><span class="comment"># check_equals_ will run too slowly otherwise.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = <span class="string">&#x27;09_angr_hooks&#x27;</span></span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Since Angr can handle the initial call to scanf, we can start from the</span></span><br><span class="line">  <span class="comment"># beginning.</span></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Hook the address of where check_equals_ is called.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  check_equals_called_address = <span class="number">0x080493ce</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># The length parameter in angr.Hook specifies how many bytes the execution</span></span><br><span class="line">  <span class="comment"># engine should skip after completing the hook. This will allow hooks to</span></span><br><span class="line">  <span class="comment"># replace certain instructions (or groups of instructions). Determine the</span></span><br><span class="line">  <span class="comment"># instructions involved in calling check_equals_, and then determine how many</span></span><br><span class="line">  <span class="comment"># bytes are used to represent them in memory. This will be the skip length.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  instruction_to_skip_length = <span class="number">5</span></span><br><span class="line"><span class="meta">  @project.hook(<span class="params">check_equals_called_address, length=instruction_to_skip_length</span>)</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">skip_check_equals_</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="comment"># Determine the address where user input is stored. It is passed as a</span></span><br><span class="line">    <span class="comment"># parameter ot the check_equals_ function. Then, load the string. Reminder:</span></span><br><span class="line">    <span class="comment"># int check_equals_(char* to_check, int length) &#123; ...</span></span><br><span class="line">    user_input_buffer_address = <span class="number">0x0804c044</span> <span class="comment"># :integer, probably hexadecimal</span></span><br><span class="line">    user_input_buffer_length = <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Reminder: state.memory.load will read the stored value at the address</span></span><br><span class="line">    <span class="comment"># user_input_buffer_address of byte length user_input_buffer_length.</span></span><br><span class="line">    <span class="comment"># It will return a bitvector holding the value. This value can either be</span></span><br><span class="line">    <span class="comment"># symbolic or concrete, depending on what was stored there in the program.</span></span><br><span class="line">    user_input_string = state.memory.load(</span><br><span class="line">      user_input_buffer_address,</span><br><span class="line">      user_input_buffer_length</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Determine the string this function is checking the user input against.</span></span><br><span class="line">    <span class="comment"># It&#x27;s encoded in the name of this function; decompile the program to find</span></span><br><span class="line">    <span class="comment"># it.</span></span><br><span class="line">    check_against_string = <span class="string">&#x27;DOQTDXIUESUOZCMW&#x27;</span> <span class="comment"># :string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># gcc uses eax to store the return value, if it is an integer. We need to</span></span><br><span class="line">    <span class="comment"># set eax to 1 if check_against_string == user_input_string and 0 otherwise.</span></span><br><span class="line">    <span class="comment"># However, since we are describing an equation to be used by z3 (not to be</span></span><br><span class="line">    <span class="comment"># evaluated immediately), we cannot use Python if else syntax. Instead, we </span></span><br><span class="line">    <span class="comment"># have to use claripy&#x27;s built in function that deals with if statements.</span></span><br><span class="line">    <span class="comment"># claripy.If(expression, ret_if_true, ret_if_false) will output an</span></span><br><span class="line">    <span class="comment"># expression that evaluates to ret_if_true if expression is true and</span></span><br><span class="line">    <span class="comment"># ret_if_false otherwise.</span></span><br><span class="line">    <span class="comment"># Think of it like the Python &quot;value0 if expression else value1&quot;.</span></span><br><span class="line">    state.regs.eax = claripy.If(</span><br><span class="line">      user_input_string == check_against_string, </span><br><span class="line">      claripy.BVV(<span class="number">1</span>, <span class="number">32</span>), </span><br><span class="line">      claripy.BVV(<span class="number">0</span>, <span class="number">32</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again.&#x27;</span> <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Since we are allowing Angr to handle the input, retrieve it by printing</span></span><br><span class="line">    <span class="comment"># the contents of stdin. Use one of the early levels as a reference.</span></span><br><span class="line">    solution = solution_state.posix.dumps(sys.stdin.fileno())</span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="10-angr-simprocedures"><a href="#10-angr-simprocedures" class="headerlink" title="10_angr_simprocedures"></a>10_angr_simprocedures</h3><p>看一下这丧心病狂函数调用图，发现check_equals_ 这个函数被调用了很多次</p>
<img src="/2022/05/09/Reverse-angr/image-20220506163556300.png" class title="image-20220506163556300">
<p>这里通过函数名来hook函数，通过hook_symbol来实现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"># This challenge is similar to the previous one. It operates under the same</span><br><span class="line"># premise that you will have to replace the check_equals_ function. In this</span><br><span class="line"># case, however, check_equals_ is called so many times that it wouldn&#x27;t make</span><br><span class="line"># sense to hook where each one was called. Instead, use a SimProcedure to write</span><br><span class="line"># your own check_equals_ implementation and then hook the check_equals_ symbol</span><br><span class="line"># to replace all calls to scanf with a call to your SimProcedure.</span><br><span class="line">#</span><br><span class="line"># You may be thinking:</span><br><span class="line">#   Why can&#x27;t I just use hooks? The function is called many times, but if I hook</span><br><span class="line">#   the address of the function itself (rather than the addresses where it is</span><br><span class="line">#   called), I can replace its behavior everywhere. Furthermore, I can get the</span><br><span class="line">#   parameters by reading them off the stack (with memory.load(regs.esp + xx)),</span><br><span class="line">#   and return a value by simply setting eax! Since I know the length of the</span><br><span class="line">#   function in bytes, I can return from the hook just before the &#x27;ret&#x27;</span><br><span class="line">#   instruction is called, which will allow the program to jump back to where it</span><br><span class="line">#   was before it called my hook.</span><br><span class="line"># If you thought that, then congratulations! You have just invented the idea of</span><br><span class="line"># SimProcedures! Instead of doing all of that by hand, you can let the already-</span><br><span class="line"># implemented SimProcedures do the boring work for you so that you can focus on</span><br><span class="line"># writing a replacement function in a Pythonic way.</span><br><span class="line"># As a bonus, SimProcedures allow you to specify custom calling conventions, but</span><br><span class="line"># unfortunately it is not covered in this CTF.</span><br><span class="line"></span><br><span class="line">import angr</span><br><span class="line">import claripy</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">def main(argv):</span><br><span class="line">  path_to_binary = &#x27;10_angr_simprocedures&#x27;</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  # Define a class that inherits angr.SimProcedure in order to take advantage</span><br><span class="line">  # of Angr&#x27;s SimProcedures.</span><br><span class="line">  class ReplacementCheckEquals(angr.SimProcedure):</span><br><span class="line">    # A SimProcedure replaces a function in the binary with a simulated one</span><br><span class="line">    # written in Python. Other than it being written in Python, the function</span><br><span class="line">    # acts largely the same as any function written in C. Any parameter after</span><br><span class="line">    # &#x27;self&#x27; will be treated as a parameter to the function you are replacing.</span><br><span class="line">    # The parameters will be bitvectors. Additionally, the Python can return in</span><br><span class="line">    # the ususal Pythonic way. Angr will treat this in the same way it would</span><br><span class="line">    # treat a native function in the binary returning. An example:</span><br><span class="line">    #</span><br><span class="line">    # int add_if_positive(int a, int b) &#123;</span><br><span class="line">    #   if (a &gt;= 0 &amp;&amp; b &gt;= 0) return a + b;</span><br><span class="line">    #   else return 0;</span><br><span class="line">    # &#125;</span><br><span class="line">    #</span><br><span class="line">    # could be simulated with...</span><br><span class="line">    #</span><br><span class="line">    # class ReplacementAddIfPositive(angr.SimProcedure):</span><br><span class="line">    #   def run(self, a, b):</span><br><span class="line">    #     if a &gt;= 0 and b &gt;=0:</span><br><span class="line">    #       return a + b</span><br><span class="line">    #     else:</span><br><span class="line">    #       return 0</span><br><span class="line">    #</span><br><span class="line">    # Finish the parameters to the check_equals_ function. Reminder:</span><br><span class="line">    # int check_equals_AABBCCDDEEFFGGHH(char* to_check, int length) &#123; ...</span><br><span class="line">    # (!)</span><br><span class="line">    def run(self, to_check, len):</span><br><span class="line">      # We can almost copy and paste the solution from the previous challenge.</span><br><span class="line">      # Hint: Don&#x27;t look up the address! It&#x27;s passed as a parameter.</span><br><span class="line">      # (!)</span><br><span class="line">      user_input_buffer_address = to_check</span><br><span class="line">      user_input_buffer_length = len</span><br><span class="line"></span><br><span class="line">      # Note the use of self.state to find the state of the system in a </span><br><span class="line">      # SimProcedure.</span><br><span class="line">      user_input_string = self.state.memory.load(</span><br><span class="line">        user_input_buffer_address,</span><br><span class="line">        user_input_buffer_length</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      check_against_string = &#x27;WXMXMQFENIXLIZMK&#x27;</span><br><span class="line">      </span><br><span class="line">      # Finally, instead of setting eax, we can use a Pythonic return statement</span><br><span class="line">      # to return the output of this function. </span><br><span class="line">      # Hint: Look at the previous solution.</span><br><span class="line">      return claripy.If(check_against_string==user_input_string, claripy.BVV(1,32), claripy.BVV(0,32))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  # Hook the check_equals symbol. Angr automatically looks up the address </span><br><span class="line">  # associated with the symbol. Alternatively, you can use &#x27;hook&#x27; instead</span><br><span class="line">  # of &#x27;hook_symbol&#x27; and specify the address of the function. To find the </span><br><span class="line">  # correct symbol, disassemble the binary.</span><br><span class="line">  # (!)</span><br><span class="line">  check_equals_symbol = &#x27;check_equals_WXMXMQFENIXLIZMK&#x27; # :string</span><br><span class="line">  project.hook_symbol(check_equals_symbol, ReplacementCheckEquals())</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  def is_successful(state):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    return b&#x27;Good Job.&#x27; in stdout_output</span><br><span class="line"></span><br><span class="line">  def should_abort(state):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    return b&#x27;Try again.&#x27; in stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  if simulation.found:</span><br><span class="line">    solution_state = simulation.found[0]</span><br><span class="line"></span><br><span class="line">    solution = solution_state.posix.dumps(sys.stdin.fileno())</span><br><span class="line">    print(solution)</span><br><span class="line">  else:</span><br><span class="line">    raise Exception(&#x27;Could not find the solution&#x27;)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="11-angr-sim-scanf"><a href="#11-angr-sim-scanf" class="headerlink" title="11_angr_sim_scanf"></a>11_angr_sim_scanf</h3><p>利用上一题学到的hook知识去hook scanf函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"># This time, the solution involves simply replacing scanf with our own version,</span><br><span class="line"># since Angr does not support requesting multiple parameters with scanf.</span><br><span class="line"></span><br><span class="line">import angr</span><br><span class="line">import claripy</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">def main(argv):</span><br><span class="line">  path_to_binary = &#x27;11_angr_sim_scanf&#x27;</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  class ReplacementScanf(angr.SimProcedure):</span><br><span class="line">    # Finish the parameters to the scanf function. Hint: &#x27;scanf(&quot;%u %u&quot;, ...)&#x27;.</span><br><span class="line">    # (!)</span><br><span class="line">    def run(self, format_string, scanf0_address, scanf1_address):</span><br><span class="line">      # Hint: scanf0_address is passed as a parameter, isn&#x27;t it?</span><br><span class="line">      scanf0 = claripy.BVS(&#x27;scanf0&#x27;, 32)</span><br><span class="line">      scanf1 = claripy.BVS(&#x27;scanf1&#x27;, 32)</span><br><span class="line"></span><br><span class="line">      # The scanf function writes user input to the buffers to which the </span><br><span class="line">      # parameters point.</span><br><span class="line">      self.state.memory.store(scanf0_address, scanf0, endness=project.arch.memory_endness)</span><br><span class="line">      self.state.memory.store(scanf1_address, scanf1, endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">      # Now, we want to &#x27;set aside&#x27; references to our symbolic values in the</span><br><span class="line">      # globals plugin included by default with a state. You will need to</span><br><span class="line">      # store multiple bitvectors. You can either use a list, tuple, or multiple</span><br><span class="line">      # keys to reference the different bitvectors.</span><br><span class="line">      # (!)</span><br><span class="line">      self.state.globals[&#x27;solution0&#x27;] = scanf0</span><br><span class="line">      self.state.globals[&#x27;solution1&#x27;] = scanf1</span><br><span class="line"></span><br><span class="line">  scanf_symbol = &#x27;__isoc99_scanf&#x27;</span><br><span class="line">  project.hook_symbol(scanf_symbol, ReplacementScanf())</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  def is_successful(state):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    return b&#x27;Good Job.&#x27; in stdout_output</span><br><span class="line"></span><br><span class="line">  def should_abort(state):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    return b&#x27;Try again.&#x27; in stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  if simulation.found:</span><br><span class="line">    solution_state = simulation.found[0]</span><br><span class="line"></span><br><span class="line">    # Grab whatever you set aside in the globals dict.</span><br><span class="line">    stored_solutions0 = solution_state.solver.eval(solution_state.globals[&#x27;solution0&#x27;])</span><br><span class="line">    stored_solutions1 = solution_state.solver.eval(solution_state.globals[&#x27;solution1&#x27;])</span><br><span class="line">    solution = str(stored_solutions0)+&#x27; &#x27;+str(stored_solutions1)</span><br><span class="line"></span><br><span class="line">    print(solution)</span><br><span class="line">  else:</span><br><span class="line">    raise Exception(&#x27;Could not find the solution&#x27;)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="12-angr-veritesting"><a href="#12-angr-veritesting" class="headerlink" title="12_angr_veritesting"></a>12_angr_veritesting</h3><p>利用<strong>Veritesting</strong>来解决路径爆炸问题</p>
<blockquote>
<p>动态符号执行（DSE）和静态符号执行（SSE）一个为路径生成公式，一个为语句生成公式。前者生成公式时会产生很高的负载，但生成的公式很容易解；后者生成公式很容易，公式也能覆盖更多的路径，但是公式更长更难解。方法上的区别在于DSE会摘要路径汇合点上两条分支的情况，而SSE为两条分支fork两条独立的执行路径</p>
<p>SSE目前还不能对大规模的程序分析（如Cloud9+state merging），问题主要在于循环的表示、方程复杂度、缺少具体状态、和对syscall等的模拟。Veritesting可以在SSE和DSE之间切换，减少负载和公式求解难度，并解决静态方法需要摘要或其他方法才能处理的系统调用和间接跳转</p>
<p>简单来说就是Veritesting结合了静态符合执行与动态符号执行，减少了路径爆炸的影响，在angr里我们只要在构造模拟管理器时，启用Veritesting了就行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">project.factory.simgr(initial_state, veritesting=True)</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># When you construct a simulation manager, you will want to enable Veritesting:</span><br><span class="line"># project.factory.simgr(initial_state, veritesting=True)</span><br><span class="line"># Hint: use one of the first few levels&#x27; solutions as a reference.</span><br><span class="line">import angr </span><br><span class="line">import claripy</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">def main(argv):</span><br><span class="line">  path_to_binary = &#x27;12_angr_veritesting&#x27;</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state,veritesting=True)</span><br><span class="line"></span><br><span class="line">  def is_successful(state):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    return b&#x27;Good Job.&#x27; in stdout_output</span><br><span class="line"></span><br><span class="line">  def should_abort(state):</span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    return b&#x27;Try again.&#x27; in stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  if simulation.found:</span><br><span class="line">    solution_state = simulation.found[0]</span><br><span class="line"></span><br><span class="line">    solution = solution_state.posix.dumps(sys.stdin.fileno()).decode()</span><br><span class="line"></span><br><span class="line">    print(solution)</span><br><span class="line">  else:</span><br><span class="line">    raise Exception(&#x27;Could not find the solution&#x27;)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="13-angr-static-binary"><a href="#13-angr-static-binary" class="headerlink" title="13_angr_static_binary"></a>13_angr_static_binary</h3><p>拖进IDA后可以发现，文件是静态编译的，此时需要利用angr提供的函数hook掉静态库里的函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"># This challenge is the exact same as the first challenge, except that it was</span><br><span class="line"># compiled as a static binary. Normally, Angr automatically replaces standard</span><br><span class="line"># library functions with SimProcedures that work much more quickly.</span><br><span class="line">#</span><br><span class="line"># To solve the challenge, manually hook any standard library c functions that</span><br><span class="line"># are used. Then, ensure that you begin the execution at the beginning of the</span><br><span class="line"># main function. Do not use entry_state.</span><br><span class="line">#</span><br><span class="line"># Here are a few SimProcedures Angr has already written for you. They implement</span><br><span class="line"># standard library functions. You will not need all of them:</span><br><span class="line"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;malloc&#x27;]</span><br><span class="line"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;fopen&#x27;]</span><br><span class="line"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;fclose&#x27;]</span><br><span class="line"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;fwrite&#x27;]</span><br><span class="line"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;getchar&#x27;]</span><br><span class="line"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;strncmp&#x27;]</span><br><span class="line"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;strcmp&#x27;]</span><br><span class="line"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;scanf&#x27;]</span><br><span class="line"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;printf&#x27;]</span><br><span class="line"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;puts&#x27;]</span><br><span class="line"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;exit&#x27;]</span><br><span class="line">#</span><br><span class="line"># As a reminder, you can hook functions with something similar to:</span><br><span class="line"># project.hook(malloc_address, angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;malloc&#x27;]())</span><br><span class="line">#</span><br><span class="line"># There are many more, see:</span><br><span class="line"># https://github.com/angr/angr/tree/master/angr/procedures/libc</span><br><span class="line">#</span><br><span class="line"># Additionally, note that, when the binary is executed, the main function is not</span><br><span class="line"># the first piece of code called. In the _start function, __libc_start_main is</span><br><span class="line"># called to start your program. The initialization that occurs in this function</span><br><span class="line"># can take a long time with Angr, so you should replace it with a SimProcedure.</span><br><span class="line"># angr.SIM_PROCEDURES[&#x27;glibc&#x27;][&#x27;__libc_start_main&#x27;]</span><br><span class="line"># Note &#x27;glibc&#x27; instead of &#x27;libc&#x27;.</span><br><span class="line">import angr</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">def main(argv):</span><br><span class="line"></span><br><span class="line">  path_to_binary = &#x27;13_angr_static_binary&#x27;  # :string</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">  	addr=0x08049e1f,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line">  # </span><br><span class="line">  project.hook(0x0804a250,angr.SIM_PROCEDURES[&#x27;glibc&#x27;][&#x27;__libc_start_main&#x27;]())</span><br><span class="line">  project.hook(0x08051340,angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;scanf&#x27;]())</span><br><span class="line">  project.hook(0x080512f0,angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;printf&#x27;]())</span><br><span class="line">  project.hook(0x0805ec90,angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;puts&#x27;]())</span><br><span class="line">  project.hook(0x080490d0,angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;strcmp&#x27;]())</span><br><span class="line">  project.hook(0x08050800,angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;exit&#x27;]())</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  print_good_address = 0x08049f06  # :integer (probably in hexadecimal)</span><br><span class="line">  simulation.explore(find=print_good_address)</span><br><span class="line"></span><br><span class="line">  if simulation.found:</span><br><span class="line"></span><br><span class="line">    solution_state = simulation.found[0]</span><br><span class="line"></span><br><span class="line">    print(solution_state.posix.dumps(sys.stdin.fileno()).decode())</span><br><span class="line">  else:</span><br><span class="line">    raise Exception(&#x27;Could not find the solution&#x27;)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="14-angr-shared-library"><a href="#14-angr-shared-library" class="headerlink" title="14_angr_shared_library"></a>14_angr_shared_library</h3><p>拖进IDA，可以发现关键函数validate属于外部库</p>
<img src="/2022/05/09/Reverse-angr/image-20220509104313706-16520641942771.png" class title="image-20220509104313706">
<p>此时通过加载.so文件可以求解问题，这时需要指定基地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">base = <span class="number">0x08048000</span></span><br><span class="line">project = angr.Project(path_to_binary, load_options=&#123;</span><br><span class="line">    <span class="string">&#x27;main_opts&#x27;</span> : &#123;</span><br><span class="line">      <span class="string">&#x27;base_addr&#x27;</span> : base</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The shared library has the function validate, which takes a string and returns</span></span><br><span class="line"><span class="comment"># either true (1) or false (0). The binary calls this function. If it returns</span></span><br><span class="line"><span class="comment"># true, the program prints &quot;Good Job.&quot; otherwise, it prints &quot;Try again.&quot;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note: When you run this script, make sure you run it on</span></span><br><span class="line"><span class="comment"># lib14_angr_shared_library.so, not the executable. This level is intended to</span></span><br><span class="line"><span class="comment"># teach how to analyse binary formats that are not typical executables.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = <span class="string">&#x27;lib14_angr_shared_library.so&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># The shared library is compiled with position-independent code. You will need</span></span><br><span class="line">  <span class="comment"># to specify the base address. All addresses in the shared library will be</span></span><br><span class="line">  <span class="comment"># base + offset, where offset is their address in the file.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  base = <span class="number">0x08048000</span></span><br><span class="line">  project = angr.Project(path_to_binary, load_options=&#123;</span><br><span class="line">    <span class="string">&#x27;main_opts&#x27;</span> : &#123;</span><br><span class="line">      <span class="string">&#x27;base_addr&#x27;</span> : base</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Initialize any symbolic values here; you will need at least one to pass to</span></span><br><span class="line">  <span class="comment"># the validate function.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  buffer_pointer = claripy.BVV(<span class="number">0x10000000</span>, <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Begin the state at the beginning of the validate function, as if it was</span></span><br><span class="line">  <span class="comment"># called by the program. Determine the parameters needed to call validate and</span></span><br><span class="line">  <span class="comment"># replace &#x27;parameters...&#x27; with bitvectors holding the values you wish to pass.</span></span><br><span class="line">  <span class="comment"># Recall that &#x27;claripy.BVV(value, size_in_bits)&#x27; constructs a bitvector</span></span><br><span class="line">  <span class="comment"># initialized to a single value.</span></span><br><span class="line">  <span class="comment"># Remember to add the base value you specified at the beginning to the</span></span><br><span class="line">  <span class="comment"># function address!</span></span><br><span class="line">  <span class="comment"># Hint: int validate(char* buffer, int length) &#123; ...</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  validate_function_address = base + <span class="number">0x129c</span></span><br><span class="line">  initial_state = project.factory.call_state(</span><br><span class="line">                    validate_function_address,</span><br><span class="line">                    buffer_pointer,</span><br><span class="line">                    claripy.BVV(<span class="number">8</span>,<span class="number">32</span>)</span><br><span class="line">                  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Inject a symbolic value for the password buffer into the program and</span></span><br><span class="line">  <span class="comment"># instantiate the simulation. Another hint: the password is 8 bytes long.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  password = claripy.BVS( <span class="string">&#x27;password&#x27;</span>, <span class="number">64</span> )</span><br><span class="line">  initial_state.memory.store( buffer_pointer , password)</span><br><span class="line">  </span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># We wish to reach the end of the validate function and constrain the</span></span><br><span class="line">  <span class="comment"># return value of the function (stored in eax) to equal true (value of 1)</span></span><br><span class="line">  <span class="comment"># just before the function returns. We could use a hook, but instead we</span></span><br><span class="line">  <span class="comment"># can search for the address just before the function returns and then</span></span><br><span class="line">  <span class="comment"># constrain eax</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  check_constraint_address = base + <span class="number">0x134c</span></span><br><span class="line">  simulation.explore(find=check_constraint_address)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Determine where the program places the return value, and constrain it so</span></span><br><span class="line">    <span class="comment"># that it is true. Then, solve for the solution and print it.</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    solution_state.add_constraints( solution_state.regs.eax!=<span class="number">0</span> )</span><br><span class="line">    solution = solution_state.solver.<span class="built_in">eval</span>(password,cast_to=<span class="built_in">bytes</span>)</span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="15-angr-arbitrary-read"><a href="#15-angr-arbitrary-read" class="headerlink" title="15_angr_arbitrary_read"></a>15_angr_arbitrary_read</h3><h3 id="16-angr-arbitrary-write"><a href="#16-angr-arbitrary-write" class="headerlink" title="16_angr_arbitrary_write"></a>16_angr_arbitrary_write</h3><h3 id="17-angr-arbitrart-jump"><a href="#17-angr-arbitrart-jump" class="headerlink" title="17_angr_arbitrart_jump"></a>17_angr_arbitrart_jump</h3><h2 id="题目-from-各类比赛"><a href="#题目-from-各类比赛" class="headerlink" title="题目 from 各类比赛"></a>题目 from 各类比赛</h2><p>部分来源 <a target="_blank" rel="noopener" href="https://github.com/angr/angr-doc/tree/master/examples">angr-doc/examples at master · angr/angr-doc (github.com)</a></p>
<h3 id="WUSTCTF2020-funnyre"><a href="#WUSTCTF2020-funnyre" class="headerlink" title="[WUSTCTF2020]funnyre"></a>[WUSTCTF2020]funnyre</h3><p>去掉花指令后：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">import angr</span><br><span class="line">import claripy</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">def main(argv):</span><br><span class="line">  path_to_binary = &#x27;attachment&#x27;</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  start_address = 0x4005d9</span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  password0 = claripy.BVS(&#x27;password0&#x27;, 8*38)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  password0_address = initial_state.regs.rdx</span><br><span class="line">  initial_state.memory.store(password0_address, password0)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  simulation.explore(find=0x401dae, avoid=0x401da2)</span><br><span class="line"></span><br><span class="line">  if simulation.found:</span><br><span class="line">    solution_state = simulation.found[0]</span><br><span class="line"></span><br><span class="line">    # Solve for the symbolic values. We are trying to solve for a string.</span><br><span class="line">    # Therefore, we will use eval, with named parameter cast_to=bytes</span><br><span class="line">    # which returns bytes that can be decoded to a string instead of an integer.</span><br><span class="line">    # (!)</span><br><span class="line">    solution0 = solution_state.solver.eval(password0,cast_to=bytes).decode()</span><br><span class="line">    solution = solution0</span><br><span class="line"></span><br><span class="line">    print(solution)</span><br><span class="line">  else:</span><br><span class="line">    raise Exception(&#x27;Could not find the solution&#x27;)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="ais3-crackme"><a href="#ais3-crackme" class="headerlink" title="[ais3_crackme]"></a>[ais3_crackme]</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">ais3_crackme has been developed by Tyler Nighswander (tylerni7) for ais3.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">It is an easy crackme challenge. It checks the command line argument.</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    project = angr.Project(<span class="string">&quot;./ais3_crackme&quot;</span>, auto_load_libs=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#create an initial state with a symbolic bit vector as argv1</span></span><br><span class="line">    argv1 = claripy.BVS(<span class="string">&quot;argv1&quot;</span>,<span class="number">100</span>*<span class="number">8</span>) <span class="comment">#since we do not the length now, we just put 100 bytes</span></span><br><span class="line">    initial_state = project.factory.entry_state(args=[<span class="string">&quot;./crackme1&quot;</span>,argv1])</span><br><span class="line"></span><br><span class="line">    <span class="comment">#create a path group using the created initial state </span></span><br><span class="line">    sm = project.factory.simulation_manager(initial_state)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#symbolically execute the program until we reach the wanted value of the instruction pointer</span></span><br><span class="line">    sm.explore(find=<span class="number">0x400602</span>) <span class="comment">#at this instruction the binary will print(the &quot;correct&quot; message)</span></span><br><span class="line"></span><br><span class="line">    found = sm.found[<span class="number">0</span>]</span><br><span class="line">    <span class="comment">#ask to the symbolic solver to get the value of argv1 in the reached state as a string</span></span><br><span class="line">    solution = found.solver.<span class="built_in">eval</span>(argv1, cast_to=<span class="built_in">bytes</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">repr</span>(solution))</span><br><span class="line">    solution = solution[:solution.find(<span class="string">b&quot;\x00&quot;</span>)]</span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">    <span class="keyword">return</span> solution</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    res = main()</span><br><span class="line">    <span class="keyword">assert</span> res == <span class="string">b&quot;ais3&#123;I_tak3_g00d_n0t3s&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">repr</span>(main()))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/5.3_symbolic_execution.html">5.3 符号执行 · CTF All In One (gitbooks.io)</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://firmianay.gitbooks.io/ctf-all-in-one/content/doc/5.3.1_angr.html">5.3.1 angr · CTF All In One (gitbooks.io)</a></p>
</li>
<li><a target="_blank" rel="noopener" href="https://docs.angr.io/">README - angr Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ZERO-A-ONE/AngrCTF_FITM/tree/master/笔记">AngrCTF_FITM/笔记 at master · ZERO-A-ONE/AngrCTF_FITM (github.com)</a></li>
</ul>
</div><div class="article-licensing box"><div class="licensing-title"><p>Reverse angr</p><p><a href="http://curator-kim.github.io/2022/05/09/Reverse-angr/">http://curator-kim.github.io/2022/05/09/Reverse-angr/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><a href="http://Curator-Kim.github.io"><p>Curator-Kim</p></a></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2022-05-09</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2022-12-26</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="recommend-area"><div class="recommend-post"><span class="is-size-6 has-text-grey has-mr-7"># Related Post</span><br><span>  1.<a class="is-size-6" href="/2023/01/09/HWS2023%20Winter%20Wp/" target="_blank"> </a><br></span><span>  2.<a class="is-size-6" href="/2023/01/09/%E5%A4%8D%E5%81%A5%E8%AE%AD%E7%BB%83/" target="_blank">复健训练</a><br></span><span>  3.<a class="is-size-6" href="/2022/09/06/%E7%BE%8A%E5%9F%8E%E6%9D%AFwp/" target="_blank">羊城杯2022 wp</a><br></span><span>  4.<a class="is-size-6" href="/2022/08/14/Crypto-NTRU%E5%AF%86%E7%A0%81%E7%B3%BB%E7%BB%9F/" target="_blank">Crypto NTRU密码系统</a><br></span><span>  5.<a class="is-size-6" href="/2022/08/14/HWS2022%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%9C%A8%E7%BA%BF%E5%A4%8F%E4%BB%A4%E8%90%A5/" target="_blank">HWS2022硬件安全在线夏令营</a><br></span><span>  6.<a class="is-size-6" href="/2022/07/24/DASCTF-2022-07-wp/" target="_blank">DASCTF 2022.07 wp</a><br></span><span>  7.<a class="is-size-6" href="/2022/05/27/DASCTF-MAY/" target="_blank">DASCTF MAY</a><br></span><span>  8.<a class="is-size-6" href="/2022/05/05/DASCTF-Apr-Writeup/" target="_blank">DASCTF Apr Writeup</a><br></span></div></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/css/share.min.css"><div class="social-share"></div><script src="https://cdnjs.loli.net/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>Alipay</span><span class="qrcode"><img src="https://github.com/Curator-Kim/Curator-Kim.github.io/blob/master/img/alipay.png?raw=true" alt="Alipay"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>Wechat</span><span class="qrcode"><img src="https://github.com/Curator-Kim/Curator-Kim.github.io/blob/master/img/wechat.png?raw=true" alt="Wechat"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2022/05/27/DASCTF-MAY/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">DASCTF MAY</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/05/05/DASCTF-Apr-Writeup/"><span class="level-item">DASCTF Apr Writeup</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--><div class="card"><div class="card-content"><div class="title is-5">Comments</div><div id="comment-container"></div><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/gitalk/1.6.0/gitalk.css"><script> $.getScript('/js/gitalk.min.js', function () { 
            var gitalk = new Gitalk({
            language:'zh-CN',
            id: '0b5995360e1c8fe119df90069aceab92',
            repo: 'blog_comment',
            owner: 'Curator-Kim',
            clientID: '46a9f3481b46ea0129d8',
            clientSecret: '79c7c9cb847e141757d7864453bcbf89f0655b24',
            admin: ["Curator-Kim"],
            createIssueManually: true,
            distractionFreeMode: false,
            perPage: 10,
            pagerDirection: 'last',
            proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token',
            
            enableHotKey: true,
            isLocked: false
        })
        gitalk.render('comment-container')});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="is-flex is-mobile" href="#符号执行"><span>符号执行</span></a></li><li><a class="is-flex is-mobile" href="#Angr"><span>Angr</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#安装"><span>安装</span></a></li><li><a class="is-flex is-mobile" href="#使用方法"><span>使用方法</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#新建一个工程"><span>新建一个工程</span></a></li><li><a class="is-flex is-mobile" href="#设置state"><span>设置state</span></a></li><li><a class="is-flex is-mobile" href="#设置-Simulation-Managers"><span>设置 Simulation Managers</span></a></li><li><a class="is-flex is-mobile" href="#运行，探索满足路径需要的值"><span>运行，探索满足路径需要的值</span></a></li><li><a class="is-flex is-mobile" href="#获取执行结果"><span>获取执行结果</span></a></li><li><a class="is-flex is-mobile" href="#位向量-bitvector"><span>位向量(bitvector)</span></a></li><li><a class="is-flex is-mobile" href="#访问寄存器"><span>访问寄存器</span></a></li><li><a class="is-flex is-mobile" href="#eval"><span>eval</span></a></li><li><a class="is-flex is-mobile" href="#Hook"><span>Hook</span></a></li><li><a class="is-flex is-mobile" href="#Hooking-Symbols"><span>Hooking Symbols</span></a></li><li><a class="is-flex is-mobile" href="#pre-binary-选项"><span>pre-binary 选项</span></a></li></ul></li></ul></li><li><a class="is-flex is-mobile" href="#题目-from-angr-CTF"><span>题目 from angr CTF</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#00-angr-find"><span>00_angr_find</span></a></li><li><a class="is-flex is-mobile" href="#01-angr-avoid"><span>01_angr_avoid</span></a></li><li><a class="is-flex is-mobile" href="#02-angr-find-condition"><span>02_angr_find_condition</span></a></li><li><a class="is-flex is-mobile" href="#03-angr-simbolic-registers"><span>03_angr_simbolic_registers</span></a></li><li><a class="is-flex is-mobile" href="#04-angr-symbolic-stack"><span>04_angr_symbolic_stack</span></a></li><li><a class="is-flex is-mobile" href="#05-angr-symbolic-memory"><span>05_angr_symbolic_memory</span></a></li><li><a class="is-flex is-mobile" href="#06-angr-symbolic-dynamic-memory"><span>06_angr_symbolic_dynamic_memory</span></a></li><li><a class="is-flex is-mobile" href="#07-angr-symbolic-file"><span>07_angr_symbolic_file</span></a></li><li><a class="is-flex is-mobile" href="#08-angr-constraints"><span>08_angr_constraints</span></a></li><li><a class="is-flex is-mobile" href="#09-angr-hooks"><span>09_angr_hooks</span></a></li><li><a class="is-flex is-mobile" href="#10-angr-simprocedures"><span>10_angr_simprocedures</span></a></li><li><a class="is-flex is-mobile" href="#11-angr-sim-scanf"><span>11_angr_sim_scanf</span></a></li><li><a class="is-flex is-mobile" href="#12-angr-veritesting"><span>12_angr_veritesting</span></a></li><li><a class="is-flex is-mobile" href="#13-angr-static-binary"><span>13_angr_static_binary</span></a></li><li><a class="is-flex is-mobile" href="#14-angr-shared-library"><span>14_angr_shared_library</span></a></li><li><a class="is-flex is-mobile" href="#15-angr-arbitrary-read"><span>15_angr_arbitrary_read</span></a></li><li><a class="is-flex is-mobile" href="#16-angr-arbitrary-write"><span>16_angr_arbitrary_write</span></a></li><li><a class="is-flex is-mobile" href="#17-angr-arbitrart-jump"><span>17_angr_arbitrart_jump</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#题目-from-各类比赛"><span>题目 from 各类比赛</span></a><ul class="menu-list"><li><a class="is-flex is-mobile" href="#WUSTCTF2020-funnyre"><span>[WUSTCTF2020]funnyre</span></a></li><li><a class="is-flex is-mobile" href="#ais3-crackme"><span>[ais3_crackme]</span></a></li></ul></li><li><a class="is-flex is-mobile" href="#参考资料"><span>参考资料</span></a></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://github.com/Curator-Kim/Curator-Kim.github.io/blob/22a41709ffc26f62191d72a87ffbb342d46bfce3/img/icon.jpg?raw=true" alt="Curator-Kim"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Curator-Kim</p><p class="is-size-6 is-block">寻几处好景破星光</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>火星</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">33</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">14</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ppoffice" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/curator-kim"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="/804242129@qq.com"><i class="fa fa-envelope"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div><div><hr><p id="hitokoto">:D 一言句子获取中...</p><script type="text/javascript" defer>function getYiyan(){
                                $.getJSON("https://v1.hitokoto.cn/", function (data) {
                                if(data){
                                    $('#hitokoto').html("");
                                    $('#hitokoto').append("<strong style='color: #3273dc;'>"+data.hitokoto+"</strong>"+
                                    "<p>"+"From《"+data.from+"》</p><p>Provider-"+data.creator+"</p>");
                                }});}
                                $(function (){getYiyan();$('#hitokoto').click(function(){getYiyan();})});</script></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><!--!--><div class="card widget"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-01-09T13:23:27.000Z">2023-01-09</time></p><p class="title"><a href="/2023/01/09/HWS2023%20Winter%20Wp/"> </a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-01-09T13:23:07.000Z">2023-01-09</time></p><p class="title"><a href="/2023/01/09/%E5%A4%8D%E5%81%A5%E8%AE%AD%E7%BB%83/">复健训练</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-09-05T16:22:59.000Z">2022-09-06</time></p><p class="title"><a href="/2022/09/06/%E7%BE%8A%E5%9F%8E%E6%9D%AFwp/">羊城杯2022 wp</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-08-14T09:42:10.000Z">2022-08-14</time></p><p class="title"><a href="/2022/08/14/Crypto-NTRU%E5%AF%86%E7%A0%81%E7%B3%BB%E7%BB%9F/">Crypto NTRU密码系统</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-08-13T16:44:15.000Z">2022-08-14</time></p><p class="title"><a href="/2022/08/14/HWS2022%E7%A1%AC%E4%BB%B6%E5%AE%89%E5%85%A8%E5%9C%A8%E7%BA%BF%E5%A4%8F%E4%BB%A4%E8%90%A5/">HWS2022硬件安全在线夏令营</a></p></div></article></div></div><!--!--><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2023/01/"><span class="level-start"><span class="level-item">January 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2022/09/"><span class="level-start"><span class="level-item">September 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2022/08/"><span class="level-start"><span class="level-item">August 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2022/07/"><span class="level-start"><span class="level-item">July 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2022/05/"><span class="level-start"><span class="level-item">May 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><a class="level is-mobile is-marginless" href="/archives/"><span class="level-start"><span class="level-item">查看全部&gt;&gt;</span></span></a></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/CTF/"><span class="tag">CTF</span><span class="tag is-grey-lightest">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/"><span class="tag">汇编语言</span><span class="tag is-grey-lightest">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Crypto/"><span class="tag">Crypto</span><span class="tag is-grey-lightest">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ctf/"><span class="tag">ctf</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwn/"><span class="tag">pwn</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CopperSmith/"><span class="tag">CopperSmith</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DES/"><span class="tag">DES</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HWS/"><span class="tag">HWS</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NTRU/"><span class="tag">NTRU</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RE/"><span class="tag">RE</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Reverse/"><span class="tag">Reverse</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/angr/"><span class="tag">angr</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99/"><span class="tag">参考资料</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86/"><span class="tag">预备知识</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><!--!--><div class="column-right-shadow is-hidden-widescreen"></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://github.com/Curator-Kim/Curator-Kim.github.io/blob/master/img/logo.png?raw=true" alt="Curator-Kim的小站" height="28"></a><p class="size-small"><span>&copy; 2023 Curator-Kim</span>  Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a> &amp; <a href="https://github.com/removeif/hexo-theme-amazing" target="_blank">Amazing</a> <br><span>© <a href="http://www.beian.miit.gov.cn/" target="_blank">粤ICP备88888888号-8（测试）</a><br></span><span>© 版权说明：[本网站所有内容均收集于互联网或自己创作,<br />&nbsp;&nbsp;&nbsp;&nbsp;方便于网友与自己学习交流，如有侵权，请<a href="/message" target="_blank">留言</a>，立即处理]<br /></span><span><span id="statistic-times">loading...</span><script>function createTime(time) {
            var n = new Date(time);
            now.setTime(now.getTime() + 250),
                days = (now - n) / 1e3 / 60 / 60 / 24,
                dnum = Math.floor(days),
                hours = (now - n) / 1e3 / 60 / 60 - 24 * dnum,
                hnum = Math.floor(hours),
            1 == String(hnum).length && (hnum = "0" + hnum),
                minutes = (now - n) / 1e3 / 60 - 1440 * dnum - 60 * hnum,
                mnum = Math.floor(minutes),
            1 == String(mnum).length && (mnum = "0" + mnum),
                seconds = (now - n) / 1e3 - 86400 * dnum - 3600 * hnum - 60 * mnum,
                snum = Math.round(seconds),
            1 == String(snum).length && (snum = "0" + snum),
                document.getElementById("statistic-times").innerHTML = "❤️Site from <strong>"+time.split(" ")[0].replace(/\//g,".")+"</strong> has existed <strong>" + dnum + "</strong> d <strong>" + hnum + "</strong> h <strong>" + mnum + "</strong> m <strong>" + snum + "</strong> s！❤️";
        }var now = new Date();setInterval("createTime('2022/1/21 00:00:00')", 250,"");</script><br></span><div class="size-small"><span>❤️Thx <strong><span id="busuanzi_value_site_uv">99+</span></strong> users <strong><span id="busuanzi_value_site_pv">99+</span></strong> visited！❤️</span></div></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/removeif/hexo-theme-amazing"><i class="fab fa-github"></i></a></p></div><div class="sideMusic"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="/js/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script><meting-js style="width: auto;height: 2000px;" server="netease" type="playlist" id="137510737" theme="#2980b9" loop="all" autoplay="false" order="list" storageName="aplayer-setting" lrctype="0" list-max-height="400px" fixed="true"></meting-js></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" async></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><script src="/js/main.js" defer></script><script>$.getScript('/js/comment-issue-data.js',function(){loadIssueData('46a9f3481b46ea0129d8','79c7c9cb847e141757d7864453bcbf89f0655b24','Curator-Kim','blog_comment',false);})</script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.js"></script><script type="text/javascript">var pjax = new Pjax({
            elements: "a",//代表点击链接就更新
            selectors: [  //代表要更新的节点
                ".section",
                "title"
            ],
            cache: true,
            cacheBust:false
        })

        function loadBusuanzi(){
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js", function () {});
        }

        function loadMathJax() { //加载mathjax
            $.getScript("//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML", function () {
                MathJax.Hub.Config({ tex2jax: { inlineMath: [['$', '$'], ['\(', '\)']] } });
                var math = document.getElementsByClassName("entry-content")[0];
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, math]);
            });
        };

        // 开始 PJAX 执行的函数
        document.addEventListener('pjax:send', function () {
        });
        
        // PJAX 完成之后执行的函数，可以和上面的重载放在一起
        document.addEventListener('pjax:complete', function () {
            $(".section").css({opacity:1});
            if(false){
                $.getScript('/js/comment-issue-data.js',function(){loadIssueData('46a9f3481b46ea0129d8','79c7c9cb847e141757d7864453bcbf89f0655b24','Curator-Kim','blog_comment',false);});
            }
            if(false){
                loadMathJax();
            }
            loadMainJs(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings);
            loadBackTop();
            loadBusuanzi();
            if(typeof loadBanner == 'function'){
                loadBanner();
            }
        });</script></body></html>